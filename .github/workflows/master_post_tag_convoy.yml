---
name: Create Tag POST API to Convoy
on:
  workflow_call:
    inputs:
      tag:
        description: 'Tag created during create-tag'
        required: true
        type: string
      uses_custom_version:
        description: 'Key for using version as tag'
        required: true
        type: string

jobs:
  
  push-commit-details-to-convoy: 
    runs-on: non-build
    env:
      API_URL: http://${{vars.CONVOY_DEV_API_ENDPOINT}}/devops/git-metadata/commits
      API_KEY: ${{secrets.CONVOY_AUTH_TOKEN}}
      BASE_BRANCH: "${{github.event.pull_request.base.ref}}"
      CI-BRANCH: TDEVOPS-1832
      COMMIT_HASH: "${{github.sha}}"
      COMMITTED_AT: "${{github.event.pull_request.merged_at}}"
      GH_API_URL: ${{vars.GH_API_URL}}
      GITHUB_TOKEN: ${{ secrets.CIPIPELINE_GITHUB_TOKEN }}
      PR_ID: "${{github.event.number}}"
      OWNER: ${{github.repository_owner}}
      REPO: "${{github.event.pull_request.base.repo.name}}"
      SLACK_WEBHOOK_URL: ${{ secrets.CONVOY_ALERTS_SLACK_URL }}
      TAG: "${{inputs.tag}}"
      USER: ${{secrets.CIPIPELINE_GITHUB_USER}}
      USES_CUSTOM_VERSION: "${{inputs.uses_custom_version}}"
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: Setup CI Scripts
        run: |
          cd ~/convoy-ci
          git checkout ${{env.CI-BRANCH}}
          git pull
          cd ~-
          cp -r ~/convoy-ci/.github/ci-scripts ./ci-scripts

      - name: POST API to Convoy
        run: |
          python3 ./ci-scripts/python/post_tag_convoy.py

      - name: Slack Notification
        uses: act10ns/slack@v2.0.0
        with:
            status: ${{ job.status }}
            steps: ${{ toJson(steps) }}
            channel: ${{ secrets.CONVOY_ALERTS_SLACK_CHANNEL  }}
        if: failure()
          
