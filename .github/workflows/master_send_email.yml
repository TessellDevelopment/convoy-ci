---
name: Send email on failure
on:
  workflow_call:

jobs:
  send-email:
    runs-on: amd64
    steps:
      - name: Get PR-Author,subject & body to send email
        run: |
          echo "MAILID=$(git log -1 '${{ github.event.pull_request.head.sha }}' --pretty=format:'%ae')" >> $GITHUB_ENV
          echo "BODY=JOB_STATUS : ${{ job.status }} %0A WORKFLOW : ${{ github.workflow }} %0A EVENT : ${{ github.event_name }} %0A BRANCH : ${{ env.SOURCE_BRANCH }} %0A COMMIT_ID : ${{ github.sha }} %0A REPO : ${{ github.repository }}" >> $GITHUB_ENV
   
      - name: sending output
        id: mail_info
        run: |
          echo "mail_id=${{ env.MAILID }}" >> $GITHUB_OUTPUT
          echo "mail_subject=***${{ job.status }}*** || ${{ github.workflow }}  ||  ${{ github.repository }} " >> $GITHUB_OUTPUT
          echo "mail_body=${{ env.BODY }}" >> $GITHUB_OUTPUT

      - name: Send Email to PR Author
        uses: wadeww/send-email-action@master
        with:
          server_address:  ${{ secrets.EMAIL_SERVER_ADDRESS }}
          port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ steps.mail_info.outputs.mail_subject }}
          body: ${{ steps.mail_info.outputs.mail_body }}
          to: ${{ steps.mail_info.outputs.mail_id }},${{ secrets.CIPIPELINE_USER_EMAIL }}
          from: ${{ secrets.CIPIPELINE_USER_EMAIL }}