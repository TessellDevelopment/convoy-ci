---
name: Version Check in Nexus
on:
  workflow_call:

jobs:

  convoy-check:
    runs-on: non-build
    outputs:
      check: ${{steps.convoy_check.outputs.check}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0
          
      - name: Check convoy.yaml version exists
        id: convoy_check
        run: |
          if [ -f convoy.yaml ]; then
            if grep -q 'version' convoy.yaml; then
              echo "Version found in convoy.yaml"
              echo "check=true" >> $GITHUB_OUTPUT
            else
              if grep -q 'terraform' convoy.yaml; then
                echo "Tf-module repository running version check"
                echo "check=true" >> $GITHUB_OUTPUT
              elif grep -q 'helm' convoy.yaml; then
                echo "Helm repository running version check"
                echo "check=true" >> $GITHUB_OUTPUT
              else
                echo "Version not found in convoy.yaml"
                echo "check=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "convoy.yaml not present, skipping version check."
            echo "check=false" >> $GITHUB_OUTPUT
          fi

  version-check:
    if: needs.convoy-check.outputs.check == 'true'
    needs: convoy-check
    runs-on: non-build-test
    env: 
      CI-BRANCH: TDEVOPS-1832
      NEXUS_URL: ${{vars.NEXUS_PROTOCOL_LOCAL}}://${{vars.NEXUS_SERVER_ENDPOINT_LOCAL}}/service/rest/v1/search?repository
      NEXUS_PUSH_REPOS_HELM: "${{vars.NEXUS_PUSH_REPOS_HELM}}"
      NEXUS_PUSH_REPOS_M2: "${{vars.NEXUS_PUSH_REPOS_M2}}"
      NEXUS_PUSH_REPOS_PY: "${{vars.NEXUS_PUSH_REPOS_PY}}"
      NEXUS_USERNAME: ${{secrets.CIPIPELINE_NEXUS_USERNAME}}
      NEXUS_PASSWORD: ${{ secrets.CIPIPELINE_NEXUS_PASSWORD}}
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0 
        
      - name: Changed files
        id: changed-files
        uses: tj-actions/changed-files@v42.0.2
        with:
          files: |
            services/**

      - name: Check All file changes
        id: changed-files-all
        uses: tj-actions/changed-files@v42.0.2

      - name: Setup CI Scripts
        run: |
          cd ~/convoy-ci
          git checkout ${{env.CI-BRANCH}}
          git pull
          cd ~-
          cp -r ~/convoy-ci/.github/scripts ./scripts

      - name: Check Version in Nexus 
        env:
          ANY_MODIFIED: "${{steps.changed-files.outputs.any_modified}}"
          CHANGED_MODIFIED_FILES: "${{steps.changed-files-all.outputs.all_changed_and_modified_files}}"
        run: |
          node ./scripts/javascript/checkVersion.js